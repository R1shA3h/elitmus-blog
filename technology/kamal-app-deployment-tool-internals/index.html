<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Kamal App Deployment Tool &#8211; eLitmus Blog</title>
<meta name="description" content="We learn new things everyday, and we document our learnings here...">

<meta name="keywords" content="kamal, deployment, docker, rails, ruby">

<!-- Twitter Cards -->
  <meta name="twitter:card" content="summary">    
<meta name="twitter:title" content="Kamal App Deployment Tool">
<meta name="twitter:description" content="Kamal is a simple, dedicated orchestration tool built specifically for deploying containerized applications (mainly Rails). In this blog post, I will take a deep dive into the internal workings of Kamal, exploring its high-level architecture and key deployment phases.

">
<meta name="twitter:site" content="@elitmus">
<meta name="twitter:image" content="/blog/images/default_og.png">

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    




<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:image" content="/blog/images/default_og.png"/>
<meta property="og:image:width" content="1280"/>
<meta property="og:image:height" content="720"/>
<meta property="og:type" content="article">
<meta property="og:title" content="Kamal App Deployment Tool">
<meta property="og:description" content="Kamal is a simple, dedicated orchestration tool built specifically for deploying containerized applications (mainly Rails). In this blog post, I will take a deep dive into the internal workings of Kamal, exploring its high-level architecture and key deployment phases.

">
<meta property="og:url" content="/blog/technology/kamal-app-deployment-tool-internals/">
<meta property="og:site_name" content="eLitmus Blog">








<link rel="canonical" href="https://www.elitmus.com/blog/technology/kamal-app-deployment-tool-internals/">
<link href="/blog/feed.xml" type="application/atom+xml" rel="alternate" title="eLitmus Blog Feed">


	<link rel="author" href="https://plus.google.com/+eLitmus?rel=author">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Icons -->
<!-- apple touch icons -->
<link rel="apple-touch-icon" sizes="57x57" href="/blog/images/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="114x114" href="/blog/images/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/blog/images/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="144x144" href="/blog/images/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="60x60" href="/blog/images/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="120x120" href="/blog/images/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="76x76" href="/blog/images/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="152x152" href="/blog/images/apple-touch-icon-152x152.png">
<!-- Favicons default 16x16 -->
<link rel="shortcut icon" type="image/vnd.microsoft.icon" href="/blog/favicon.ico">

<!-- Favicons others -->
<link rel="icon" type="image/png" href="/blog/images/favicon-196x196.png" sizes="196x196">
<link rel="icon" type="image/png" href="/blog/images/favicon-160x160.png" sizes="160x160">
<link rel="icon" type="image/png" href="/blog/images/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/blog/images/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/blog/images/favicon-32x32.png" sizes="32x32">

<!-- Icons for Windows 8 Tiles -->
<meta name="msapplication-TileColor" content="#ffffff"/>
<meta name="msapplication-TileImage" content="/blog/images/mstile-144x144.png">

<!-- For all browsers -->


<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:600,300,300italic|The+Girl+Next+Door" rel="stylesheet" type="text/css">
<link href='//fonts.googleapis.com/css?family=Source+Code+Pro:300' rel='stylesheet' type='text/css'>

<meta http-equiv="cleartype" content="on">

<!-- bootstrap 4 -->
<link rel="stylesheet" type="text/css" href="/blog/assets/css/bootstrap.min.css">

<!-- below css file is used for navbar in individual blogposts -->
<link rel="stylesheet" type="text/css" href="/blog/assets/css/main.min.css">

<!-- <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css"> -->

<!-- Optional theme -->
<link rel="stylesheet" type="text/css" href="/blog/assets/css/bootstrap-theme.min.css">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Font Awesome -->
<link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" />
<link rel="stylesheet" type="text/css" href="/blog/assets/css/font-elitmuslogo.css" />

<link rel="stylesheet" href="/blog/assets/css/customize.css">
<link rel="stylesheet" href="/blog/assets/css/forkit.css">

<!-- Prism -->
<link rel="stylesheet" href="/blog/assets/css/prism.css">

</head>

<body id="post">

  <header class="headroom">

  <nav class="navbar navbar-expand-md navbar-dark bg-black fixed-top" role="navigation">

      <a class="navbar-brand" href="/blog/">
        <img src="/blog/images/elitmus-only-logo.svg" class="img-logo">
        <span><div class="blog-label">blog</div></span>
      </a>

      <!-- the toggle button -->
      <button type="button" class="navbar-toggler" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="navbar-toggler-icon"></span>
        <span class="sr-only">Toggle navigation</span><!-- only for screen readers -->
      </button>

      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav mr-auto">

          <!-- first item = dropdown search -->
          <li class="nav-item">
            <div class="dropdown search-box-margin">

            
              <div class="form-inline">
                 

                <input data-toggle="dropdown" placeholder="Search..." id="search-box" class="form-control form-control-sm search-input dropdown-toggle" aria-haspopup="true" aria-expanded="false">


                <div class="dropdown-menu" id="search-dropdown">
                  <a role='presentation' class='dropdown-item search-results'> Type more.... </a>
                </div>

              </div>



            <!-- the below line will pass "search word" to search.html -->

            <!--
            <form class="form-inline" action="/blog/search" method="get">
               


              <label for="search_box">Search</label>
              <input data-toggle="dropdown" type="text" name="query" placeholder="Search..." id="search-box" class="form-control form-control-sm search-input dropdown-toggle" aria-haspopup="true" aria-expanded="false">

              <div class="dropdown-menu" id="search-dropdown">
                  <a role='presentation' class='dropdown-item search-results'> Type more.... </a>
              </div>

              <input type="submit" value="search">

            </form>
            -->

            <!-- end of form -->


            </div>
          </li>
        </ul>

        

        <!-- every link on the right side -->
        <ul class="nav navbar-nav navbar-right nav-icon-size-reduce">
          
          <li class="nav-item">
             
              <a href="/blog/" class="nav-link">
                <i class="fa fa-home"></i> Home
              </a>
            
          </li>
          
          <li class="nav-item">
             
              <a href="/blog/posts/" class="nav-link">
                <i class="fa fa-file-text-o"></i> Posts
              </a>
            
          </li>
          
          <li class="nav-item">
             
              <a href="//www.elitmus.com/" class="nav-link">
                <i class="el el-elitmuslogo"></i> eLitmus
              </a>
            
          </li>
          

          <!-- feed is the last link -->
          <li class="nav-item">
            <a href="/blog/feed.xml" class="nav-link" title="Atom/RSS feed">
              <i class="fa fa-rss"></i> Feed
            </a>
          </li>
        </ul>



      </div> <!-- /.navbar-collapse -->

  </nav><!--[if lt IE 9]><div class="upgrade"><strong><a href="https://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
</header>
<!-- 

  <div class="search-wrapper">
    <div class="search-form">
      <input type="text" class="search-field" placeholder="Search...">
      <i class="icon-remove-sign icon-2x"></i>
      <ul class="search-results post-list"></ul> -->
<!-- /.search-results -->
<!-- </div> -->
<!-- /.search-form -->
<!-- </div> -->
<!-- ./search-wrapper -->
<!--  -->

  

  <div class="container-fluid">

  <div class="row">


    <div class="col-md-2"></div>
      <div class="col-md-8">
        <div id="main" role="main" class="marginal ">
          <article class="entry">

          

            <div>
              <header>
                <span class="entry-tags">
                  
                    <a href="/blog/tags/#kamal" title="Pages tagged kamal">kamal</a>
                    &nbsp;&bull;&nbsp;
                  
                    <a href="/blog/tags/#deployment" title="Pages tagged deployment">deployment</a>
                    &nbsp;&bull;&nbsp;
                  
                    <a href="/blog/tags/#docker" title="Pages tagged docker">docker</a>
                    &nbsp;&bull;&nbsp;
                  
                    <a href="/blog/tags/#rails" title="Pages tagged rails">rails</a>
                    &nbsp;&bull;&nbsp;
                  
                    <a href="/blog/tags/#ruby" title="Pages tagged ruby">ruby</a>
                    
                  

                  <div class=' social-sharing pull-right'>        
     
</div>

                </span>
              
                
                  <h1 class="no-padding">Kamal App Deployment Tool</h1>
                
              </header>
            </div>
           
            <div>
              <div>
                <span class='badge badge-warning'> <a href="/blog/categories/technology/index.html" > technology </a></span>
              </div>

              

              <div class="post-content-justify">
                <p>Kamal is a simple, dedicated orchestration tool built specifically for deploying containerized applications (mainly Rails). In this blog post, I will take a deep dive into the internal workings of Kamal, exploring its high-level architecture and key deployment phases.</p>

<h4 id="high-level-architecture-of-kamal"><strong>High Level Architecture of Kamal</strong></h4>
<p>We can divide Kamal deployment in 3 parts</p>
<ol>
  <li>Build</li>
  <li>Push Image to container registry</li>
  <li>Deploy</li>
</ol>

<div style=" text-align: center; margin: 20px;">
  <img src="/blog/images/kamal-deploy/High-level-arch.png" />
</div>

<h5 id="build-phase"><strong>Build Phase</strong></h5>
<p>The build process can occur either locally or on a remote server. Its primary purpose is to create images compatible with both amd64 and arm64 architectures. Kamal employs a straightforward Docker-in-Docker strategy for cross-platform builds, making it seamless to create images that work across different architectures.</p>

<h5 id="container-registry"><strong>Container Registry</strong></h5>
<p>When using <code>kamal build</code> command, the tool automatically pushes the newly built image to your container registry. If you’re handling the build process separately, you’ll need to manage the registry push manually. Kamal supports most major container registries out of the box (e.g. Docker hub / AWS ECR).</p>

<h5 id="deploy-phase-the-core-magic"><strong>Deploy Phase: The Core Magic</strong></h5>
<p>This is the core of Kamal’s deployment process, which goes beyond just pulling the image and starting a container. Here’s a step by step breakdown of what Kamal does under the hood during deployment:</p>

<ul>
  <li>SSH into servers &amp; start by removing any outdated image with the same tag on each server, ensuring the environment is clean.</li>
  <li>Then, it pulls the latest version of the Docker image from the registry</li>
  <li>Kamal integrates with Kamal-proxy (or similar proxies) to manage network routing. It checks if the kamal-proxy is active, which is essential for rerouting traffic to the new container when it’s ready.</li>
  <li>Kamal Now, first replaces the old container name to <code>_replaced</code> than start this new primary container &amp; will wait for healthcheck to be passed to consider it as healthy.</li>
  <li>Once the above step completed Kamal starts the secondary containers.</li>
  <li>After confirming that the new containers are stable, Kamal prunes old containers and images, freeing up disk space and reducing clutter on servers. This cleanup ensures efficient resource use over time.</li>
</ul>

<div style=" text-align: center; margin: 20px;">
  <img src="/blog/images/kamal-deploy/deploy.png" />
</div>

<h4 id="practical-uses"><strong>Practical Uses</strong></h4>
<p>Kamal can be used in multiple ways -</p>

<ul>
  <li>As a cross platform image builder.</li>
  <li>For deploying pre-built containerized applications (Build step can be taken care by someone else).
    <ul>
      <li>Deploy step can be done for any containerized application.</li>
      <li>Platform specific deployment to multiple nodes in parallel.</li>
    </ul>
  </li>
  <li>As an end-to-end solution handling both build and deploy phases.</li>
</ul>

<h4 id="prerequisites-to-use-kamal"><strong>Prerequisites to use Kamal</strong></h4>
<ul>
  <li>Ruby Environment.</li>
  <li>A containerized application.</li>
  <li>Access to container registry.</li>
  <li>Server Infrastructure (Bare Metal / EC2 / Google Cloud )
    <ul>
      <li>SSH Keys Setup so that kamal can access the servers during deploy.</li>
    </ul>
  </li>
</ul>

<h4 id="steps"><strong>Steps</strong></h4>
<ul>
  <li>Install latest ruby</li>
  <li>Initialize kamal
    <ul>
      <li>Install kamal gem. <code>gem install kamal</code></li>
      <li>In app directory run <code>kamal init</code> (This can be run outside of project directory if build is not part of the deployment)</li>
    </ul>
  </li>
  <li>Configure deployment settings in <code>config/deploy.yml</code></li>
  <li>For multiple environments, create specific config files(e.g. staging / UAT / production)
config/deploy.staging.yml<code>
config/deploy.production.yml</code></li>
</ul>

<h5 id="build-configuration"><strong>Build Configuration</strong></h5>
<p>Kamal offers flexible options for managing the build process.</p>
<ul>
  <li>Within same project folder using <code>config/deploy.yml</code></li>
</ul>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">builder:
  arch: amd64</code></pre></figure>

<ul>
  <li>Specify external project locations, if <code>config/deploy.yml</code> is in different folder:</li>
</ul>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">builder:
    arch: amd64
    context: &#39;path_to_project_base&#39; 
    dockerfile: &#39;path_to_dockerfile&#39;
    args:
      COMMIT_SHA: 1.0.0 # default it picks up the latest commit hash.</code></pre></figure>

<h6 id="image-tagging"><strong>Image Tagging</strong></h6>
<p>By default, Kamal uses Git commit hashes for image tagging. This provides automatic versioning based on your Git history. However, you can customize this behavior if you want to create your own tags:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">builder:
  # Other configurations...
  args:
    # Override default git hash-based tag
    COMMIT_SHA: 1.0.0</code></pre></figure>

<p>Once configuration are set use <code>kamal build</code> to finish up the build process.</p>

<p>To deploy a specific version we need to pass <code>VERSION</code> during deploy</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">VERSION=1.0.0 kamal deploy -P</code></pre></figure>

<h5 id="deploy-configurations"><strong>Deploy configurations</strong></h5>
<p>Kamal gives us following commands to deploy application -</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">kamal setup    # First-time setup and deployment
kamal deploy   # Standard deployment
kamal redeploy # Just Deploy without bootstrapping servers / proxy containers</code></pre></figure>

<p><strong>Pro Tip</strong>: Add <code>-P</code> or <code>--skip-push</code> to any command to skip the build and push phases. This is particularly useful when you’re using a separate CI/CD pipeline for building images:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">kamal deploy -P  # Deploy without image build &amp; push step</code></pre></figure>

<h5 id="managing-database-migrations"><strong>Managing Database Migrations</strong></h5>
<p>We can use following approaches to run the migrations so that migrations runs only in primary server.</p>

<h6 id="using-hooks"><strong>Using Hooks</strong></h6>
<p>Hooks are Kamal’s way of executing commands at specific points in the deployment process. Here’s the complete hooks list.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">docker-setup
pre-connect
pre-build
pre-deploy
post-deploy
pre-proxy-reboot
post-proxy-reboot</code></pre></figure>

<p>For migrations, the <code>pre_deploy</code> hook can be used, insert the below code in <code>hooks/pre-delploy</code> file:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">VERSION=$KAMAL_VERSION kamal app exec -p &quot;./bin/rails db:prepare&quot;</code></pre></figure>

<h6 id="server-tags-for-migration-control"><strong>Server Tags for Migration Control</strong></h6>
<p>To run migrations using server tags we can do following steps</p>

<ol>
  <li>Add a tag to the server</li>
  <li>Create Env variable for that tag</li>
  <li>Use that ENV variable in docker-entrypoint</li>
</ol>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">config.yml
servers:
  - 172.0.0.1: db
  - 172.0.0.2
  - 172.0.0.3
  
env:
  clear:
    MYSQL_USER: app
  secret:
    - MYSQL_PASSWORD
  tags:
    db:
      MIGRATION: 1</code></pre></figure>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">if [ &quot;$RUN_MIGRATIONS&quot; = &quot;1&quot; ]; then
  echo &quot;Running database migrations...&quot;
  bundle exec rails db:migrate
fi</code></pre></figure>

<p>For Detailed discussion on Database migration visit <a href="https://github.com/basecamp/kamal/discussions/526" target="_blank" style="color: blue;">Github Discussion</a></p>

<h4 id="references"><strong>References</strong></h4>
<ul>
  <li><a href="https://github.com/basecamp/kamal" target="_blank" style="color: blue;">Kamal github</a></li>
  <li><a href="https://kamal-deploy.org" target="_blank" style="color: blue;">Kamal Docs</a></li>
</ul>

              </div>
              <div class="entry-tags">
                <div class=' social-sharing pull-right'>        
     
</div>
              </div>
              <div class="clearfix"><br/></div>

                <div class="panel panel-default">

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

</div>
                <div id='discourse-comments'></div>

<script type="text/javascript">
  DiscourseEmbed = { discourseUrl: 'https://adda.elitmus.com/',
                     discourseEmbedUrl: 'https://www.elitmus.com/blog/technology/kamal-app-deployment-tool-internals/'
                   };

  (function() {
    var d = document.createElement('script'); 
    d.type = 'text/javascript'; 
    d.async = true;
    d.src = DiscourseEmbed.discourseUrl + 'javascripts/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(d);
  })();
</script>


                
              </div><!-- /.entry-content -->
            </div><!-- /.entry-wrapper -->

          </article>

          <nav class="navbar nav-justified" role="navigation">
            <ul class="nav pager">
              
                <li class="previous showElem mr-auto"><a href="/blog/technology/improving-drag-in-reactjs-a-smoother-approach-to-draggable-elements/" title="Improving Drag in React JS: A Smoother Approach to Draggable Elements">&larr;<span class="showPrevNex"> Previous </span> </a></li>
              
              
            </ul>
          </nav>
        
        </div><!-- /#main -->

      <!--/col-md-2 -->
      <div class="col-md-2">

      </div>

    </div><!-- /row -->
    </div>
    <div class="footer-color">
      <footer role="contentinfo">
        <center>
            <span class='footer-text'>
    &copy;  2005-<script> document.write(new Date().getFullYear()) </script>, eLitmus.com. | <a href="/terms_of_use/">Terms of Use</a> &middot; <a href="/privacy_policy/">Privacy Policy</a>

  </span>
        </center>
      </footer>
    </div><!-- /.footer-wrapper -->
    

	<script async src="https://www.googletagmanager.com/gtag/js?id=G-CB7H9KN61P"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-CB7H9KN61P');
	</script>



<!-- Load Modernizr -->
<script src="/blog/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- adding jquery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<!-- end of jquery -->

<script src="/blog/assets/js/scripts.min.js"></script>
<script src="/blog/assets/js/lunr.min.js"></script>
<script src="/blog/assets/js/lunr-search.js"></script>
<script src="/blog/assets/js/plugins/headroom.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
<script src="/blog/assets/js/vendor/forkit.js"></script>

<!-- Prism -->
<script src="/blog/assets/js/prism.js"></script>
  

  </body>
</html>
