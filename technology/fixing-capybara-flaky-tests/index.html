<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Fixing Capybara Flaky Tests &#8211; eLitmus Blog</title>
<meta name="description" content="We learn new things everyday, and we document our learnings here...">

<meta name="keywords" content="capybara, rails, system-tests, flaky">

<!-- Twitter Cards -->
  <meta name="twitter:card" content="summary">    
<meta name="twitter:title" content="Fixing Capybara Flaky Tests">
<meta name="twitter:description" content="<p>When writing system tests for a user interface, it is common to encounter test cases that fail randomly. One of the common failure can occur when the JavaScript on a page takes time to render, causing issues with the test case.</p>

">
<meta name="twitter:site" content="@elitmus">

    

    

    

    

    

    

    

    

    

    

    

    

    
        
            <meta name="twitter:creator" content="@https://twitter.com/nick_bhtt">
        
    

    

    

    

    




<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:image" content="/blog/images/blog_logo_taglinedorange.png"/>
<meta property="og:type" content="article">
<meta property="og:title" content="Fixing Capybara Flaky Tests">
<meta property="og:description" content="<p>When writing system tests for a user interface, it is common to encounter test cases that fail randomly. One of the common failure can occur when the JavaScript on a page takes time to render, causing issues with the test case.</p>

">
<meta property="og:url" content="/blog/technology/fixing-capybara-flaky-tests/">

<meta property="og:site_name" content="eLitmus Blog">







<link rel="canonical" href="https://www.elitmus.com/blog/technology/fixing-capybara-flaky-tests/">
<link href="/blog/feed.xml" type="application/atom+xml" rel="alternate" title="eLitmus Blog Feed">


	<link rel="author" href="https://plus.google.com/+eLitmus?rel=author">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Icons -->
<!-- apple touch icons -->
<link rel="apple-touch-icon" sizes="57x57" href="/blog/images/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="114x114" href="/blog/images/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/blog/images/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="144x144" href="/blog/images/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="60x60" href="/blog/images/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="120x120" href="/blog/images/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="76x76" href="/blog/images/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="152x152" href="/blog/images/apple-touch-icon-152x152.png">
<!-- Favicons default 16x16 -->
<link rel="shortcut icon" type="image/vnd.microsoft.icon" href="/blog/favicon.ico">

<!-- Favicons others -->
<link rel="icon" type="image/png" href="/blog/images/favicon-196x196.png" sizes="196x196">
<link rel="icon" type="image/png" href="/blog/images/favicon-160x160.png" sizes="160x160">
<link rel="icon" type="image/png" href="/blog/images/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/blog/images/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/blog/images/favicon-32x32.png" sizes="32x32">

<!-- Icons for Windows 8 Tiles -->
<meta name="msapplication-TileColor" content="#ffffff"/>
<meta name="msapplication-TileImage" content="/blog/images/mstile-144x144.png">

<!-- For all browsers -->


<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:600,300,300italic|The+Girl+Next+Door" rel="stylesheet" type="text/css">
<link href='//fonts.googleapis.com/css?family=Source+Code+Pro:300' rel='stylesheet' type='text/css'>

<meta http-equiv="cleartype" content="on">

<!-- bootstrap 4 -->
<link rel="stylesheet" type="text/css" href="/blog/assets/css/bootstrap.min.css">

<!-- below css file is used for navbar in individual blogposts -->
<link rel="stylesheet" type="text/css" href="/blog/assets/css/main.min.css">

<!-- <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css"> -->

<!-- Optional theme -->
<link rel="stylesheet" type="text/css" href="/blog/assets/css/bootstrap-theme.min.css">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Font Awesome -->
<link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" />
<link rel="stylesheet" type="text/css" href="/blog/assets/css/font-elitmuslogo.css" />

<link rel="stylesheet" href="/blog/assets/css/customize.css">
<link rel="stylesheet" href="/blog/assets/css/forkit.css">
</head>

<body id="post">

  <header class="headroom">

  <nav class="navbar navbar-expand-md navbar-dark bg-black fixed-top" role="navigation">

      <a class="navbar-brand" href="/blog/">
        <img src="https://cdn0.elitmus.net/assets/elitmus-only-logo-6efc8a74032179afdb89829a093e05bd05d627dd4354bbd1ff7f4eb5db8a0af8.svg" class="img-logo">
        <span><div class="blog-label">blog</div></span>
      </a>

      <!-- the toggle button -->
      <button type="button" class="navbar-toggler" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="navbar-toggler-icon"></span>
        <span class="sr-only">Toggle navigation</span><!-- only for screen readers -->
      </button>

      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav mr-auto">

          <!-- first item = dropdown search -->
          <li class="nav-item">
            <div class="dropdown search-box-margin">

            
              <div class="form-inline">
                 

                <input data-toggle="dropdown" placeholder="Search..." id="search-box" class="form-control form-control-sm search-input dropdown-toggle" aria-haspopup="true" aria-expanded="false">


                <div class="dropdown-menu" id="search-dropdown">
                  <a role='presentation' class='dropdown-item search-results'> Type more.... </a>
                </div>

              </div>



            <!-- the below line will pass "search word" to search.html -->

            <!--
            <form class="form-inline" action="/blog/search" method="get">
               


              <label for="search_box">Search</label>
              <input data-toggle="dropdown" type="text" name="query" placeholder="Search..." id="search-box" class="form-control form-control-sm search-input dropdown-toggle" aria-haspopup="true" aria-expanded="false">

              <div class="dropdown-menu" id="search-dropdown">
                  <a role='presentation' class='dropdown-item search-results'> Type more.... </a>
              </div>

              <input type="submit" value="search">

            </form>
            -->

            <!-- end of form -->


            </div>
          </li>
        </ul>

        

        <!-- every link on the right side -->
        <ul class="nav navbar-nav navbar-right nav-icon-size-reduce">
          
          <li class="nav-item">
             
              <a href="/blog/" class="nav-link">
                <i class="fa fa-home"></i> Home
              </a>
            
          </li>
          
          <li class="nav-item">
             
              <a href="/blog/posts/" class="nav-link">
                <i class="fa fa-file-text-o"></i> Posts
              </a>
            
          </li>
          
          <li class="nav-item">
             
              <a href="//www.elitmus.com/" class="nav-link">
                <i class="el el-elitmuslogo"></i> eLitmus
              </a>
            
          </li>
          

          <!-- feed is the last link -->
          <li class="nav-item">
            <a href="/blog/feed.xml" class="nav-link" title="Atom/RSS feed">
              <i class="fa fa-rss"></i> Feed
            </a>
          </li>
        </ul>



      </div> <!-- /.navbar-collapse -->

  </nav><!--[if lt IE 9]><div class="upgrade"><strong><a href="https://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
</header>
<!-- 

  <div class="search-wrapper">
    <div class="search-form">
      <input type="text" class="search-field" placeholder="Search...">
      <i class="icon-remove-sign icon-2x"></i>
      <ul class="search-results post-list"></ul> -->
<!-- /.search-results -->
<!-- </div> -->
<!-- /.search-form -->
<!-- </div> -->
<!-- ./search-wrapper -->
<!--  -->

  

  <div class="container-fluid">

  <div class="row">


    <div class="col-md-2"></div>
      <div class="col-md-8">
        

        <div id="main" role="main" class="marginal">
          <article class="entry">

            

            <div>
              <header>
                <span class="entry-tags">
                  
                    <a href="/blog/tags/#capybara" title="Pages tagged capybara">capybara</a>
                    &nbsp;&bull;&nbsp;
                  
                    <a href="/blog/tags/#rails" title="Pages tagged rails">rails</a>
                    &nbsp;&bull;&nbsp;
                  
                    <a href="/blog/tags/#system-tests" title="Pages tagged system-tests">system-tests</a>
                    &nbsp;&bull;&nbsp;
                  
                    <a href="/blog/tags/#flaky" title="Pages tagged flaky">flaky</a>
                    
                  

                  <div class=' social-sharing pull-right'>        
     
</div>

                </span>
              
                
                  <h1 class="no-padding">Fixing Capybara Flaky Tests</h1>
                
              </header>
            </div>
           
            <div>
              <div>
                <span class='badge badge-warning'> <a href="/blog/categories/technology/index.html" > technology </a></span>
              </div>

              

              <div class="post-content-justify">
                <p>When writing system tests for a user interface, it is common to encounter test cases that fail randomly. One of the common failure can occur when the JavaScript on a page takes time to render, causing issues with the test case.</p>

<p>For example, imagine a test case that clicks a button on a page and then checks for the presence of certain content after the click.</p>

<p><strong>Demo Code</strong></p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span></span>visit submit_page
click_on <span class="s1">&#39;Submit&#39;</span>
assert page.has_content <span class="s1">&#39;Some content after clicking on submit&#39;</span></code></pre></figure>

<p>In most cases, this test will run without any issues. However, occasionally the test may fail on the third line with the error “Expected false to be truthy”. This error can occur when the page is visited and the JavaScript on the page takes a few seconds to load. During this time, the submit button may be clicked, but because there is no JavaScript associated with the button yet, the button click does not do anything. As a result, the test is still on the submit page when it tries to assert that the expected content is present, causing the test to fail.</p>

<p><strong>Solution</strong></p>

<p>One solution to this problem is to increase the <code>wait_time</code> setting in capybara. However, this approach has several limitations. First, the wait_time setting is global and applies to all test cases, so if it is set to a high value, it will increase the overall execution time of the test suite. Additionally, the wait_time setting only waits for a fixed amount of time before moving on with the test, without checking whether the page has finished loading. This means that if the page takes longer to load than the wait_time</p>

<p>The other solution is to use the <code>execute_script</code> method provided by Capybara to click the button instead of the <code>click_on</code> method. The execute_script method allows you to execute JavaScript code within the context of the current page. By using this method to click the button, the click action is added to the end of the browser’s call stack. This means that the click action will be executed after any existing JavaScript code on the page has finished running, ensuring that the button is fully initialized and ready to be interacted with before the test tries to click it.</p>

<p>To use the execute_script method to click the button, you can use the following code:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span></span>page.find_button<span class="o">(</span><span class="s1">&#39;Submit&#39;</span><span class="o">)</span>.execute_script<span class="o">(</span><span class="s1">&#39;this.click()&#39;</span><span class="o">)</span></code></pre></figure>

<p>This way we can ensure that click method will run only after the page javascript is fully loaded.</p>

<p><strong>Browser Call Stack</strong></p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span></span>          <span class="p">|</span>               <span class="p">|</span>
          <span class="p">|</span>               <span class="p">|</span>
          <span class="p">|</span>   JavaScript  <span class="p">|</span>  &lt;-- existing code on the page<span class="o">(</span><span class="m">1</span><span class="o">)</span>
          <span class="p">|</span>_______________<span class="p">|</span>
          <span class="p">|</span>               <span class="p">|</span>
          <span class="p">|</span>   JavaScript  <span class="p">|</span>  &lt;-- existing code on the page<span class="o">(</span><span class="m">2</span><span class="o">)</span>
          <span class="p">|</span>_______________<span class="p">|</span>
          <span class="p">|</span>               <span class="p">|</span>
          <span class="p">|</span>  click action <span class="p">|</span>  &lt;-- added by execute_script method<span class="o">(</span><span class="m">3</span><span class="o">)</span>
          <span class="p">|</span>_______________<span class="p">|</span></code></pre></figure>


              </div>
              <div class="entry-tags">
                <div class=' social-sharing pull-right'>        
     
</div>
              </div>
              <div class="clearfix"><br/></div>

                <div class="panel panel-default">

  

  

  

  

  

  

  

  

  

  

  

  

  
    
      <div class="panel-body">
        <div class="container-fluid">

          <div class="row">
            <div class="col-sm-12 col-md-4">
              <center>
                <img src="/blog/images/nikhil.jpg" alt="Nikhil Bhatt photo" class="author-photo img-circle img-responsive"/>
                
                <span class="author vcard">
                  <span class="fn">Nikhil Bhatt</span>
                </span>

                <div class="nav-icon-size-reduce social-icons">
                  
                    <a href="https://twitter.com/https://twitter.com/nick_bhtt"  title="Nikhil Bhatt on Twitter"  target="_blank"><i class="fa fa-twitter "></i></a>
                  
                  
                  
                  

                  
                    <a href="https://linkedin.com/in/nik-bhatt" title="Nikhil Bhatt on LinkedIn" target="_blank"><i class="fa fa-linkedin "></i></a>
                  

                  

                  

                  

                  
                    <a href="https://github.com/nikhilbhatt" title="Nikhil Bhatt on Github" target="_blank"><i class="fa fa-github "></i></a>
                  

                     
                </div><!-- /.social-icons -->
              </center>
            </div>

            <div class="col-sm-12 col-md-8">
              
                <span class="author-bio">Nikhil Bhatt is a member of Technology at eLitmus. He enjoys creating small, practical software applications and is enthusiastic about competitive coding and chess</span>
              
            </div>

          </div>

        </div>
      </div>

  

  

  

  

  

</div>
                <div id='discourse-comments'></div>

<script type="text/javascript">
  DiscourseEmbed = { discourseUrl: 'https://adda.elitmus.com/',
                     discourseEmbedUrl: 'https://www.elitmus.com/blog/technology/fixing-capybara-flaky-tests/'
                   };

  (function() {
    var d = document.createElement('script'); 
    d.type = 'text/javascript'; 
    d.async = true;
    d.src = DiscourseEmbed.discourseUrl + 'javascripts/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(d);
  })();
</script>


                
              </div><!-- /.entry-content -->
            </div><!-- /.entry-wrapper -->

          </article>

          <nav class="navbar nav-justified" role="navigation">
            <ul class="nav pager">
              
                <li class="previous showElem mr-auto"><a href="/blog/technology/sidekiq-process-in-production-with-systemd-and-monit/" title="Sidekiq process in production with Systemd and Monit">&larr;<span class="showPrevNex"> Previous </span> </a></li>
              
              
                <li class="next showElem ml-auto"><a href="/blog/technology/the-revamp-of-a-video-proctoring-solution-a-behind-the-scenes-look/" title="The revamp of a Video Proctoring Solution: A Behind-the-Scenes Look"> <span class='showPrevNex'> Next </span> &rarr; </a></li>
              
            </ul>
          </nav>
        
        </div><!-- /#main -->

      <!--/col-md-2 -->
      <div class="col-md-2">

      </div>

    </div><!-- /row -->
    </div>
    <div class="footer-color">
      <footer role="contentinfo">
        <center>
            <span class='footer-text'>
    &copy;  2005-<script> document.write(new Date().getFullYear()) </script>, eLitmus.com. | <a href="/terms_of_use/">Terms of Use</a> &middot; <a href="/privacy_policy/">Privacy Policy</a>

  </span>
        </center>
      </footer>
    </div><!-- /.footer-wrapper -->
    

	<script async src="https://www.googletagmanager.com/gtag/js?id=G-CB7H9KN61P"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-CB7H9KN61P');
	</script>



<!-- Load Modernizr -->
<script src="/blog/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- adding jquery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<!-- end of jquery -->

<script src="/blog/assets/js/scripts.min.js"></script>
<script src="/blog/assets/js/lunr.min.js"></script>
<script src="/blog/assets/js/lunr-search.js"></script>
<script src="/blog/assets/js/plugins/headroom.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
<script src="/blog/assets/js/vendor/forkit.js"></script>
  

  </body>
</html>
