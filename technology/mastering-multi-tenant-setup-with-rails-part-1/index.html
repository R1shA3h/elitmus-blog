<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Mastering Multi Tenant setup with rails part 1 &#8211; eLitmus Blog</title>
<meta name="description" content="We learn new things everyday, and we document our learnings here...">

<meta name="keywords" content="rails, multi-tenant, multi-db">

<!-- Twitter Cards -->
  <meta name="twitter:card" content="summary">    
<meta name="twitter:title" content="Mastering Multi Tenant setup with rails part 1">
<meta name="twitter:description" content="<p>Multi-tenancy is a software design where a single instance of a software application serves multiple customers or tenants (individual users or organizations). In a multi-tenant architecture, each tenant’s data and configuration are logically isolated from one another, providing a sense of individuality and privacy while sharing the same underlying infrastructure, codebase, and application instance.</p>

">
<meta name="twitter:site" content="@elitmus">

    

    

    

    

    

    

    

    

    

    

    

    

    
        
            <meta name="twitter:creator" content="@https://twitter.com/nick_bhtt">
        
    

    

    

    

    

    

    




<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:image" content="/blog/images/blog_logo_taglinedorange.png"/>
<meta property="og:type" content="article">
<meta property="og:title" content="Mastering Multi Tenant setup with rails part 1">
<meta property="og:description" content="<p>Multi-tenancy is a software design where a single instance of a software application serves multiple customers or tenants (individual users or organizations). In a multi-tenant architecture, each tenant’s data and configuration are logically isolated from one another, providing a sense of individuality and privacy while sharing the same underlying infrastructure, codebase, and application instance.</p>

">
<meta property="og:url" content="/blog/technology/mastering-multi-tenant-setup-with-rails-part-1/">

<meta property="og:site_name" content="eLitmus Blog">







<link rel="canonical" href="https://www.elitmus.com/blog/technology/mastering-multi-tenant-setup-with-rails-part-1/">
<link href="/blog/feed.xml" type="application/atom+xml" rel="alternate" title="eLitmus Blog Feed">


	<link rel="author" href="https://plus.google.com/+eLitmus?rel=author">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Icons -->
<!-- apple touch icons -->
<link rel="apple-touch-icon" sizes="57x57" href="/blog/images/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="114x114" href="/blog/images/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/blog/images/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="144x144" href="/blog/images/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="60x60" href="/blog/images/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="120x120" href="/blog/images/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="76x76" href="/blog/images/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="152x152" href="/blog/images/apple-touch-icon-152x152.png">
<!-- Favicons default 16x16 -->
<link rel="shortcut icon" type="image/vnd.microsoft.icon" href="/blog/favicon.ico">

<!-- Favicons others -->
<link rel="icon" type="image/png" href="/blog/images/favicon-196x196.png" sizes="196x196">
<link rel="icon" type="image/png" href="/blog/images/favicon-160x160.png" sizes="160x160">
<link rel="icon" type="image/png" href="/blog/images/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/blog/images/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/blog/images/favicon-32x32.png" sizes="32x32">

<!-- Icons for Windows 8 Tiles -->
<meta name="msapplication-TileColor" content="#ffffff"/>
<meta name="msapplication-TileImage" content="/blog/images/mstile-144x144.png">

<!-- For all browsers -->


<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:600,300,300italic|The+Girl+Next+Door" rel="stylesheet" type="text/css">
<link href='//fonts.googleapis.com/css?family=Source+Code+Pro:300' rel='stylesheet' type='text/css'>

<meta http-equiv="cleartype" content="on">

<!-- bootstrap 4 -->
<link rel="stylesheet" type="text/css" href="/blog/assets/css/bootstrap.min.css">

<!-- below css file is used for navbar in individual blogposts -->
<link rel="stylesheet" type="text/css" href="/blog/assets/css/main.min.css">

<!-- <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css"> -->

<!-- Optional theme -->
<link rel="stylesheet" type="text/css" href="/blog/assets/css/bootstrap-theme.min.css">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Font Awesome -->
<link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" />
<link rel="stylesheet" type="text/css" href="/blog/assets/css/font-elitmuslogo.css" />

<link rel="stylesheet" href="/blog/assets/css/customize.css">
<link rel="stylesheet" href="/blog/assets/css/forkit.css">
</head>

<body id="post">

  <header class="headroom">

  <nav class="navbar navbar-expand-md navbar-dark bg-black fixed-top" role="navigation">

      <a class="navbar-brand" href="/blog/">
        <img src="/blog/images/elitmus-only-logo.svg" class="img-logo">
        <span><div class="blog-label">blog</div></span>
      </a>

      <!-- the toggle button -->
      <button type="button" class="navbar-toggler" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="navbar-toggler-icon"></span>
        <span class="sr-only">Toggle navigation</span><!-- only for screen readers -->
      </button>

      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav mr-auto">

          <!-- first item = dropdown search -->
          <li class="nav-item">
            <div class="dropdown search-box-margin">

            
              <div class="form-inline">
                 

                <input data-toggle="dropdown" placeholder="Search..." id="search-box" class="form-control form-control-sm search-input dropdown-toggle" aria-haspopup="true" aria-expanded="false">


                <div class="dropdown-menu" id="search-dropdown">
                  <a role='presentation' class='dropdown-item search-results'> Type more.... </a>
                </div>

              </div>



            <!-- the below line will pass "search word" to search.html -->

            <!--
            <form class="form-inline" action="/blog/search" method="get">
               


              <label for="search_box">Search</label>
              <input data-toggle="dropdown" type="text" name="query" placeholder="Search..." id="search-box" class="form-control form-control-sm search-input dropdown-toggle" aria-haspopup="true" aria-expanded="false">

              <div class="dropdown-menu" id="search-dropdown">
                  <a role='presentation' class='dropdown-item search-results'> Type more.... </a>
              </div>

              <input type="submit" value="search">

            </form>
            -->

            <!-- end of form -->


            </div>
          </li>
        </ul>

        

        <!-- every link on the right side -->
        <ul class="nav navbar-nav navbar-right nav-icon-size-reduce">
          
          <li class="nav-item">
             
              <a href="/blog/" class="nav-link">
                <i class="fa fa-home"></i> Home
              </a>
            
          </li>
          
          <li class="nav-item">
             
              <a href="/blog/posts/" class="nav-link">
                <i class="fa fa-file-text-o"></i> Posts
              </a>
            
          </li>
          
          <li class="nav-item">
             
              <a href="//www.elitmus.com/" class="nav-link">
                <i class="el el-elitmuslogo"></i> eLitmus
              </a>
            
          </li>
          

          <!-- feed is the last link -->
          <li class="nav-item">
            <a href="/blog/feed.xml" class="nav-link" title="Atom/RSS feed">
              <i class="fa fa-rss"></i> Feed
            </a>
          </li>
        </ul>



      </div> <!-- /.navbar-collapse -->

  </nav><!--[if lt IE 9]><div class="upgrade"><strong><a href="https://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
</header>
<!-- 

  <div class="search-wrapper">
    <div class="search-form">
      <input type="text" class="search-field" placeholder="Search...">
      <i class="icon-remove-sign icon-2x"></i>
      <ul class="search-results post-list"></ul> -->
<!-- /.search-results -->
<!-- </div> -->
<!-- /.search-form -->
<!-- </div> -->
<!-- ./search-wrapper -->
<!--  -->

  

  <div class="container-fluid">

  <div class="row">


    <div class="col-md-2"></div>
      <div class="col-md-8">
        

        <div id="main" role="main" class="marginal">
          <article class="entry">

            

            <div>
              <header>
                <span class="entry-tags">
                  
                    <a href="/blog/tags/#rails" title="Pages tagged rails">rails</a>
                    &nbsp;&bull;&nbsp;
                  
                    <a href="/blog/tags/#multi-tenant" title="Pages tagged multi-tenant">multi-tenant</a>
                    &nbsp;&bull;&nbsp;
                  
                    <a href="/blog/tags/#multi-db" title="Pages tagged multi-db">multi-db</a>
                    
                  

                  <div class=' social-sharing pull-right'>        
     
</div>

                </span>
              
                
                  <h1 class="no-padding">Mastering Multi Tenant setup with rails part 1</h1>
                
              </header>
            </div>
           
            <div>
              <div>
                <span class='badge badge-warning'> <a href="/blog/categories/technology/index.html" > technology </a></span>
              </div>

              

              <div class="post-content-justify">
                <p>Multi-tenancy is a software design where a single instance of a software application serves multiple customers or tenants (individual users or organizations). In a multi-tenant architecture, each tenant’s data and configuration are logically isolated from one another, providing a sense of individuality and privacy while sharing the same underlying infrastructure, codebase, and application instance.</p>

<h4 id="single-tenant-application"><strong>Single Tenant application</strong></h4>
<p>In a single-tenant application, each hosted instance has its dedicated database. Upon addition of a new organization that requires segregated data, a new application is hosted with a different database.</p>

<div style=" text-align:center;">
  <img src="/blog/images/multi-tenant/single-tenant.png" style="height:600px" />
</div>

<h4 id="multi-tenant-application-types"><strong>Multi Tenant Application types</strong></h4>

<ol>
  <li><strong>Single Database shared rows</strong>
    <ul>
      <li>Each table in database will contain an additional row known as tenant_id.</li>
      <li>Whenever data is stored and retrieved from table this coloumn will be used to get/store the data.</li>
      <li>
        <p>Only the data that belongs to a specific customer/tenant will be fetched.</p>

        <div style=" text-align:center;">
  <img src="/blog/images/multi-tenant/single-db-shared-rows.png" style="height:600px;" />
</div>
      </li>
    </ul>
  </li>
  <li><strong>Single Database shared schema</strong>
    <ul>
      <li>For each tenant a different table will be maintained in same database.</li>
      <li>
        <p>Data will be segregated table wise.</p>

        <div style=" text-align:center;">
  <img src="/blog/images/multi-tenant/single-db-separate-tables.png" style="height:600px;" />
</div>
      </li>
    </ul>
  </li>
  <li><strong>Dedicated Database for Each Tenant</strong>
    <ul>
      <li>
        <p>For each tenant a new database schema will be maintained, it can be termed as shard.</p>

        <div style=" text-align:center;">
  <img src="/blog/images/multi-tenant/multi-tenant.png" style="height:600px;" />
</div>
      </li>
    </ul>
  </li>
</ol>

<p>In this blog post, we’ll take an in-depth look at the third approach, where we opt to manage separate databases for each tenant. To demonstrate this, we’ll walk through the process of creating a basic Rails blog application from the ground up.</p>

<h4 id="goal"><strong>Goal</strong></h4>
<ol>
  <li>Setting up a multi-tenant application in development mode.</li>
  <li>dynamically switching databases according to the requesting host name.</li>
</ol>

<h5 id="what-features-rails-6-brings-in"><strong>What features rails 6 brings in</strong></h5>
<p>Rails 6 introduced the multiple database setup with following features -</p>
<ol>
  <li>Multiple writer databases and a replica for each.</li>
  <li>Automatic connection switching for the model you’re working with.</li>
  <li>Automatic swapping between the writer and replica depending on the HTTP verb and recent writes.</li>
  <li>Rails tasks for creating, dropping, migrating, and interacting with the multiple databases.</li>
</ol>

<h4 id="setup"><strong>Setup</strong></h4>

<p><strong>Create new rails app</strong></p>

<ul>
  <li><code>rails new multi_db_blog</code></li>
  <li>update gemfile to use mysql2 instead of sqlite3</li>
</ul>

<p><strong>Setup databases</strong></p>
<ol>
  <li>In <code>database.yml</code> file update the database with name.</li>
</ol>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="ss">development</span><span class="p">:</span>
<span class="w">  </span><span class="ss">app1</span><span class="p">:</span>
<span class="w">    </span><span class="ss">adapter</span><span class="p">:</span><span class="w"> </span><span class="n">mysql2</span>
<span class="w">    </span><span class="ss">encoding</span><span class="p">:</span><span class="w"> </span><span class="n">utf8</span>
<span class="w">    </span><span class="ss">reconnect</span><span class="p">:</span><span class="w"> </span><span class="kp">false</span>
<span class="w">    </span><span class="ss">database</span><span class="p">:</span><span class="w"> </span><span class="n">app1_development</span>
<span class="w">    </span><span class="ss">pool</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span>
<span class="w">    </span><span class="ss">username</span><span class="p">:</span>
<span class="w">    </span><span class="ss">password</span><span class="p">:</span>
<span class="w">    </span><span class="ss">socket</span><span class="p">:</span> <span class="sr">/tmp/m</span><span class="n">ysql</span><span class="o">.</span><span class="n">sock</span>
<span class="w">    </span><span class="ss">host</span><span class="p">:</span><span class="w"> </span><span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span>
<span class="w">  </span><span class="ss">app2</span><span class="p">:</span>
<span class="w">    </span><span class="ss">adapter</span><span class="p">:</span><span class="w"> </span><span class="n">mysql2</span>
<span class="w">    </span><span class="ss">encoding</span><span class="p">:</span><span class="w"> </span><span class="n">utf8</span>
<span class="w">    </span><span class="ss">reconnect</span><span class="p">:</span><span class="w"> </span><span class="kp">false</span>
<span class="w">    </span><span class="ss">database</span><span class="p">:</span><span class="w"> </span><span class="n">app2_development</span>
<span class="w">    </span><span class="ss">pool</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span>
<span class="w">    </span><span class="ss">username</span><span class="p">:</span>
<span class="w">    </span><span class="ss">password</span><span class="p">:</span>
<span class="w">    </span><span class="ss">socket</span><span class="p">:</span> <span class="sr">/tmp/m</span><span class="n">ysql</span><span class="o">.</span><span class="n">sock</span>
<span class="w">    </span><span class="ss">host</span><span class="p">:</span><span class="w"> </span><span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span></code></pre></figure>

<ol start="2">
  <li><code>bin/rake db:create</code> <em>create databases for both the tenants.</em></li>
  <li>You have the option to execute specific rake commands for each database. For instance, you can create the <code>app1</code> database using the command: <code>bin/rake db:create:app1</code></li>
</ol>

<p><strong>Generate Models and Controller</strong></p>
<ol>
  <li>
    <p>Model</p>

    <p><code>bin/rails generate model Article title:string body:text</code></p>
  </li>
  <li>
    <p>Run migrations</p>

    <p><code>bin/rake db:migrate</code></p>
  </li>
  <li>
    <p>Controller</p>

    <p><code>bin/rails generate controller Articles index --skip-routes</code></p>
  </li>
  <li>
    <p>update <code>routes.rb</code> file.</p>
  </li>
</ol>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="n">root</span><span class="w"> </span><span class="s2">&quot;articles#index&quot;</span>
<span class="n">resources</span><span class="w"> </span><span class="ss">:articles</span>
<span class="w">    </span></code></pre></figure>

<p>Complete the <code>Articles</code> Controller, Model and respective views by following <a href="https://guides.rubyonrails.org/getting_started.html" target="_blank" style="color: blue;">This Guide</a></p>

<p><strong>Start App</strong></p>
<ol>
  <li>Run <code>bin/rails s</code> to start the server.</li>
  <li>By default rails will connect to db1 now.</li>
  <li>This will act as a default database for the current application.</li>
</ol>

<p><strong>Running up both databases simaltaneously</strong></p>

<p>Install nginx &amp; paste the following code in nginx.conf file.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span></span>http<span class="w"> </span><span class="o">{</span>
<span class="w">  </span>server<span class="w"> </span><span class="o">{</span>
<span class="w">   </span>listen<span class="w"> </span><span class="m">3000</span><span class="p">;</span>
<span class="w">   </span>server_name<span class="w"> </span>localhost<span class="p">;</span>

<span class="w">   </span>location<span class="w"> </span>/<span class="w"> </span><span class="o">{</span>
<span class="w">        </span>proxy_pass<span class="w"> </span>http://127.0.0.1:3000<span class="p">;</span><span class="w"> </span><span class="c1"># Rails app running on port 3000</span>
<span class="w">        </span>proxy_set_header<span class="w"> </span>Host<span class="w"> </span><span class="nv">$host</span>:<span class="nv">$server_port</span><span class="p">;</span>
<span class="w">        </span>proxy_set_header<span class="w"> </span>X-Real-IP<span class="w"> </span><span class="nv">$remote_addr</span><span class="p">;</span>
<span class="w">        </span>proxy_set_header<span class="w"> </span>X-Forwarded-For<span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<span class="w">    </span><span class="o">}</span>
<span class="w">  </span><span class="o">}</span>

<span class="w">  </span>server<span class="w"> </span><span class="o">{</span>
<span class="w">    </span>listen<span class="w"> </span><span class="m">4000</span><span class="p">;</span>
<span class="w">    </span>server_name<span class="w"> </span>localhost<span class="p">;</span><span class="w"> </span><span class="c1"># Change this to your actual domain if needed</span>

<span class="w">    </span>location<span class="w"> </span>/<span class="w"> </span><span class="o">{</span>
<span class="w">        </span>proxy_pass<span class="w"> </span>http://127.0.0.1:3000<span class="p">;</span><span class="w"> </span><span class="c1"># Rails app running on port 3000</span>
<span class="w">        </span>proxy_set_header<span class="w"> </span>Host<span class="w"> </span><span class="nv">$host</span>:<span class="nv">$server_port</span><span class="p">;</span>
<span class="w">        </span>proxy_set_header<span class="w"> </span>X-Real-IP<span class="w"> </span><span class="nv">$remote_addr</span><span class="p">;</span>
<span class="w">        </span>proxy_set_header<span class="w"> </span>X-Forwarded-For<span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<span class="w">    </span><span class="o">}</span>
<span class="w">  </span><span class="o">}</span>
<span class="o">}</span>
events<span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="o">}</span></code></pre></figure>

<p>Above nginx configurations listens to port 3000 and 4000 and redirect to rails application running in port 3000.</p>

<p><strong>Additional Rails changes</strong></p>

<p>Since We are using Rails 7 we can use automatic shard swap feature provided by rails. if using rails 6.1 or 6, a middleware can be introduced to automatic switch the tenants depending on request. Visit next section for the details.</p>

<p>Mention list of tenants in a <code>.yml</code> file. You can maintain these records in a separate database as well, for now I will create a <code>settings.yml</code> file.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="ss">development</span><span class="p">:</span>
<span class="w">  </span><span class="ss">tenants</span><span class="p">:</span>
<span class="w">    </span><span class="ss">app1</span><span class="p">:</span>
<span class="w">      </span><span class="ss">hosts</span><span class="p">:</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="ss">localhost</span><span class="p">:</span><span class="mi">3000</span>
<span class="w">    </span><span class="ss">app2</span><span class="p">:</span>
<span class="w">      </span><span class="ss">hosts</span><span class="p">:</span>
<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="ss">localhost</span><span class="p">:</span><span class="mi">4000</span></code></pre></figure>

<p>update <code>application.rb</code> with following configurations.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">configure</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">config</span><span class="o">.</span><span class="n">active_record</span><span class="o">.</span><span class="n">shard_selector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="ss">lock</span><span class="p">:</span><span class="w"> </span><span class="kp">true</span><span class="w"> </span><span class="p">}</span>

<span class="w">  </span><span class="n">tenants</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config_for</span><span class="p">(</span><span class="ss">:settings</span><span class="p">)</span><span class="o">[</span><span class="ss">:tenants</span><span class="o">]</span><span class="w">  </span><span class="c1"># maintaining list of tenants with host</span>
<span class="w">  </span><span class="n">config</span><span class="o">.</span><span class="n">active_record</span><span class="o">.</span><span class="n">shard_resolver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-&gt;</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">tenants</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">find</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">key</span><span class="o">|</span><span class="w"> </span><span class="n">tenants</span><span class="o">[</span><span class="n">key</span><span class="o">][</span><span class="ss">:hosts</span><span class="o">].</span><span class="n">include?</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s1">&#39;HTTP_HOST&#39;</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="ss">:app1</span>
<span class="w">  </span><span class="p">}</span>
<span class="k">end</span></code></pre></figure>

<p>update <code>application_record.rb</code></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="w">   </span><span class="c1"># connects_to shards: {</span>
<span class="w">   </span><span class="c1">#  app1: { writing: :app1 },</span>
<span class="w">   </span><span class="c1">#  app2: { writing: :app2 }</span>
<span class="w">   </span><span class="c1"># }</span>
<span class="w">   </span><span class="c1"># OR</span>

<span class="w">  </span><span class="no">TENANTS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config_for</span><span class="p">(</span><span class="ss">:settings</span><span class="p">)</span><span class="o">[</span><span class="ss">:tenants</span><span class="o">]</span>
<span class="w">  </span><span class="n">connects_to</span><span class="w"> </span><span class="no">TENANTS</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">shard</span><span class="o">|</span><span class="w"> </span><span class="o">[</span><span class="n">shard</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="ss">writing</span><span class="p">:</span><span class="w"> </span><span class="n">shard</span><span class="w"> </span><span class="p">}</span><span class="o">]</span><span class="w"> </span><span class="p">}</span><span class="o">.</span><span class="n">to_h</span></code></pre></figure>

<h5 id="creating-middleware-for-automatic-shard-switchingignore-if-using-rails-7-or-above"><strong>Creating Middleware for automatic shard switching(ignore if using rails 7 or above)</strong></h5>
<ol>
  <li>Create a middleware named <code>middleware/tenant_selector.rb</code></li>
  <li>Add following code</li>
</ol>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="w">  </span><span class="k">module</span><span class="w"> </span><span class="nn">Middleware</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">TenantSelector</span>
<span class="w">      </span><span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">app</span><span class="p">,</span><span class="w"> </span><span class="n">tenants</span><span class="p">)</span>
<span class="w">        </span><span class="vi">@app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">app</span>
<span class="w">        </span><span class="vi">@tenants</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tenants</span>
<span class="w">      </span><span class="k">end</span>

<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:tenants</span>

<span class="w">      </span><span class="k">def</span><span class="w"> </span><span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
<span class="w">        </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Request</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
<span class="w">        </span><span class="n">tenant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">selected_tenant</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

<span class="w">        </span><span class="n">set_tenant</span><span class="p">(</span><span class="n">tenant</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">          </span><span class="vi">@app</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">      </span><span class="k">end</span>

<span class="w">      </span><span class="kp">private</span>
<span class="w">      </span><span class="k">def</span><span class="w"> </span><span class="nf">selected_tenant</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="w">        </span><span class="n">tenants</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">find</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">key</span><span class="o">|</span><span class="w"> </span><span class="n">tenants</span><span class="o">[</span><span class="n">key</span><span class="o">][</span><span class="ss">:hosts</span><span class="o">].</span><span class="n">include?</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s1">&#39;HTTP_HOST&#39;</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="ss">:app1</span>
<span class="w">      </span><span class="k">end</span>

<span class="w">      </span><span class="k">def</span><span class="w"> </span><span class="nf">set_tenant</span><span class="p">(</span><span class="n">tenant</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
<span class="w">        </span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">connected_to</span><span class="p">(</span><span class="ss">shard</span><span class="p">:</span><span class="w"> </span><span class="n">tenant</span><span class="o">.</span><span class="n">to_sym</span><span class="p">,</span><span class="w"> </span><span class="ss">role</span><span class="p">:</span><span class="w"> </span><span class="ss">:writing</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
<span class="w">          </span><span class="k">yield</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="w">  </span></code></pre></figure>

<ol start="3">
  <li>Update <code>application.rb</code> file with following changes.</li>
</ol>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="w">    </span><span class="n">tenants</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config_for</span><span class="p">(</span><span class="ss">:settings</span><span class="p">)</span><span class="o">[</span><span class="ss">:tenants</span><span class="o">]</span>
<span class="w">    </span><span class="n">config</span><span class="o">.</span><span class="n">app_middleware</span><span class="o">.</span><span class="n">use</span><span class="w"> </span><span class="no">Middleware</span><span class="o">::</span><span class="no">TenantSelector</span><span class="p">,</span><span class="w"> </span><span class="n">tenants</span></code></pre></figure>

<p><strong>Final Steps</strong></p>

<p>Follow these final steps to confirm your multi-tenant Rails application is up and running smoothly:</p>

<ol>
  <li>Run <code>bin/rails s</code></li>
  <li>Access localhost:3000 to connect to db1</li>
  <li>Access localhost:4000 to connect to db2</li>
  <li>If you wish to add more databases, simply update the <code>database.yml</code> and <code>settings.yml</code> files</li>
</ol>

<p><strong>What Next?</strong></p>

<p>In the upcoming series of blog posts, we will delve into the following topics:</p>
<ol>
  <li>Maintaining Background Jobs.</li>
  <li>Running Rake Tasks with Cron Jobs for Multiple Databases.</li>
  <li>ActiveStorage Data Management with Different Storage Types for Each Tenant.</li>
  <li>Caching.</li>
</ol>

<h4 id="summary"><strong>Summary</strong></h4>

<p>In this blog post we covered creating a multi tenant application from scratch and setting it up in development environment. We were able to automatically switch databases according to type of database.</p>

<h4 id="references"><strong>References</strong></h4>
<ol>
  <li><a href="https://github.com/nikhilbhatt/rails-multi-db-tutorial/releases/tag/0.0.0" target="_blank" style="color: blue;">Github Code</a></li>
  <li><a href="https://guides.rubyonrails.org/active_record_multiple_databases.html" target="_blank" style="color: blue;">Rails Multi Db introduction</a></li>
</ol>

              </div>
              <div class="entry-tags">
                <div class=' social-sharing pull-right'>        
     
</div>
              </div>
              <div class="clearfix"><br/></div>

                <div class="panel panel-default">

  

  

  

  

  

  

  

  

  

  

  

  

  
    
      <div class="panel-body">
        <div class="container-fluid">

          <div class="row">
            <div class="col-sm-12 col-md-4">
              <center>
                <img src="/blog/images/nikhil.jpg" alt="Nikhil Bhatt photo" class="author-photo img-circle img-responsive"/>
                
                <span class="author vcard">
                  <span class="fn">Nikhil Bhatt</span>
                </span>

                <div class="nav-icon-size-reduce social-icons">
                  
                    <a href="https://twitter.com/https://twitter.com/nick_bhtt"  title="Nikhil Bhatt on Twitter"  target="_blank"><i class="fa fa-twitter "></i></a>
                  
                  
                  
                  

                  
                    <a href="https://linkedin.com/in/nik-bhatt" title="Nikhil Bhatt on LinkedIn" target="_blank"><i class="fa fa-linkedin "></i></a>
                  

                  

                  

                  

                  
                    <a href="https://github.com/nikhilbhatt" title="Nikhil Bhatt on Github" target="_blank"><i class="fa fa-github "></i></a>
                  

                     
                </div><!-- /.social-icons -->
              </center>
            </div>

            <div class="col-sm-12 col-md-8">
              
                <span class="author-bio">Nikhil Bhatt is a member of Technology at eLitmus. He enjoys creating small, practical software applications and is enthusiastic about competitive coding and chess</span>
              
            </div>

          </div>

        </div>
      </div>

  

  

  

  

  

  

  

</div>
                <div id='discourse-comments'></div>

<script type="text/javascript">
  DiscourseEmbed = { discourseUrl: 'https://adda.elitmus.com/',
                     discourseEmbedUrl: 'https://www.elitmus.com/blog/technology/mastering-multi-tenant-setup-with-rails-part-1/'
                   };

  (function() {
    var d = document.createElement('script'); 
    d.type = 'text/javascript'; 
    d.async = true;
    d.src = DiscourseEmbed.discourseUrl + 'javascripts/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(d);
  })();
</script>


                
              </div><!-- /.entry-content -->
            </div><!-- /.entry-wrapper -->

          </article>

          <nav class="navbar nav-justified" role="navigation">
            <ul class="nav pager">
              
                <li class="previous showElem mr-auto"><a href="/blog/technology/an-in-depth-look-at-database-indexing/" title="An in-depth look at Database Indexing">&larr;<span class="showPrevNex"> Previous </span> </a></li>
              
              
                <li class="next showElem ml-auto"><a href="/blog/technology/mastering-multi-tenant-setup-with-rails-background-jobs/" title="Mastering Multi Tenant setup with rails - background jobs"> <span class='showPrevNex'> Next </span> &rarr; </a></li>
              
            </ul>
          </nav>
        
        </div><!-- /#main -->

      <!--/col-md-2 -->
      <div class="col-md-2">

      </div>

    </div><!-- /row -->
    </div>
    <div class="footer-color">
      <footer role="contentinfo">
        <center>
            <span class='footer-text'>
    &copy;  2005-<script> document.write(new Date().getFullYear()) </script>, eLitmus.com. | <a href="/terms_of_use/">Terms of Use</a> &middot; <a href="/privacy_policy/">Privacy Policy</a>

  </span>
        </center>
      </footer>
    </div><!-- /.footer-wrapper -->
    

	<script async src="https://www.googletagmanager.com/gtag/js?id=G-CB7H9KN61P"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-CB7H9KN61P');
	</script>



<!-- Load Modernizr -->
<script src="/blog/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- adding jquery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<!-- end of jquery -->

<script src="/blog/assets/js/scripts.min.js"></script>
<script src="/blog/assets/js/lunr.min.js"></script>
<script src="/blog/assets/js/lunr-search.js"></script>
<script src="/blog/assets/js/plugins/headroom.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
<script src="/blog/assets/js/vendor/forkit.js"></script>
  

  </body>
</html>
