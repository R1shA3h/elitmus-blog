<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Custom Capacity Buffers In Go &#8211; eLitmus Blog</title>
<meta name="description" content="We learn new things everyday, and we document our learnings here...">

<meta name="keywords" content="go, ruby, buffer">

<!-- Twitter Cards -->
  <meta name="twitter:card" content="summary">    
<meta name="twitter:title" content="Custom Capacity Buffers In Go">
<meta name="twitter:description" content=" Create Buffers and Files in Golang with Custom Capacity by creating wrapper over Buffer struct in Golang">
<meta name="twitter:site" content="@elitmus">

    

    

    
        
            <meta name="twitter:creator" content="@surendrabobba">
        
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    




<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:image" content="/blog/images/blog_logo_taglinedorange.png"/>
<meta property="og:type" content="article">
<meta property="og:title" content="Custom Capacity Buffers In Go">
<meta property="og:description" content="Create Buffers and Files in Golang with Custom Capacity by creating wrapper over Buffer struct in Golang">
<meta property="og:url" content="/blog/technology/custom-capacity-buffers-in-go/">

<meta property="og:site_name" content="eLitmus Blog">







<link rel="canonical" href="https://www.elitmus.com/blog/technology/custom-capacity-buffers-in-go/">
<link href="/blog/feed.xml" type="application/atom+xml" rel="alternate" title="eLitmus Blog Feed">


	<link rel="author" href="https://plus.google.com/+eLitmus?rel=author">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Icons -->
<!-- apple touch icons -->
<link rel="apple-touch-icon" sizes="57x57" href="/blog/images/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="114x114" href="/blog/images/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/blog/images/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="144x144" href="/blog/images/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="60x60" href="/blog/images/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="120x120" href="/blog/images/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="76x76" href="/blog/images/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="152x152" href="/blog/images/apple-touch-icon-152x152.png">
<!-- Favicons default 16x16 -->
<link rel="shortcut icon" type="image/vnd.microsoft.icon" href="/blog/favicon.ico">

<!-- Favicons others -->
<link rel="icon" type="image/png" href="/blog/images/favicon-196x196.png" sizes="196x196">
<link rel="icon" type="image/png" href="/blog/images/favicon-160x160.png" sizes="160x160">
<link rel="icon" type="image/png" href="/blog/images/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/blog/images/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/blog/images/favicon-32x32.png" sizes="32x32">

<!-- Icons for Windows 8 Tiles -->
<meta name="msapplication-TileColor" content="#ffffff"/>
<meta name="msapplication-TileImage" content="/blog/images/mstile-144x144.png">

<!-- For all browsers -->


<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:600,300,300italic|The+Girl+Next+Door" rel="stylesheet" type="text/css">
<link href='//fonts.googleapis.com/css?family=Source+Code+Pro:300' rel='stylesheet' type='text/css'>

<meta http-equiv="cleartype" content="on">

<!-- bootstrap 4 -->
<link rel="stylesheet" type="text/css" href="/blog/assets/css/bootstrap.min.css">

<!-- below css file is used for navbar in individual blogposts -->
<link rel="stylesheet" type="text/css" href="/blog/assets/css/main.min.css">

<!-- <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css"> -->

<!-- Optional theme -->
<link rel="stylesheet" type="text/css" href="/blog/assets/css/bootstrap-theme.min.css">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Font Awesome -->
<link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" />
<link rel="stylesheet" type="text/css" href="/blog/assets/css/font-elitmuslogo.css" />

<link rel="stylesheet" href="/blog/assets/css/customize.css">
<link rel="stylesheet" href="/blog/assets/css/forkit.css">

<!-- Prism -->
<link rel="stylesheet" href="/blog/assets/css/prism.css">

</head>

<body id="post">

  <header class="headroom">

  <nav class="navbar navbar-expand-md navbar-dark bg-black fixed-top" role="navigation">

      <a class="navbar-brand" href="/blog/">
        <img src="/blog/images/elitmus-only-logo.svg" class="img-logo">
        <span><div class="blog-label">blog</div></span>
      </a>

      <!-- the toggle button -->
      <button type="button" class="navbar-toggler" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="navbar-toggler-icon"></span>
        <span class="sr-only">Toggle navigation</span><!-- only for screen readers -->
      </button>

      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav mr-auto">

          <!-- first item = dropdown search -->
          <li class="nav-item">
            <div class="dropdown search-box-margin">

            
              <div class="form-inline">
                 

                <input data-toggle="dropdown" placeholder="Search..." id="search-box" class="form-control form-control-sm search-input dropdown-toggle" aria-haspopup="true" aria-expanded="false">


                <div class="dropdown-menu" id="search-dropdown">
                  <a role='presentation' class='dropdown-item search-results'> Type more.... </a>
                </div>

              </div>



            <!-- the below line will pass "search word" to search.html -->

            <!--
            <form class="form-inline" action="/blog/search" method="get">
               


              <label for="search_box">Search</label>
              <input data-toggle="dropdown" type="text" name="query" placeholder="Search..." id="search-box" class="form-control form-control-sm search-input dropdown-toggle" aria-haspopup="true" aria-expanded="false">

              <div class="dropdown-menu" id="search-dropdown">
                  <a role='presentation' class='dropdown-item search-results'> Type more.... </a>
              </div>

              <input type="submit" value="search">

            </form>
            -->

            <!-- end of form -->


            </div>
          </li>
        </ul>

        

        <!-- every link on the right side -->
        <ul class="nav navbar-nav navbar-right nav-icon-size-reduce">
          
          <li class="nav-item">
             
              <a href="/blog/" class="nav-link">
                <i class="fa fa-home"></i> Home
              </a>
            
          </li>
          
          <li class="nav-item">
             
              <a href="/blog/posts/" class="nav-link">
                <i class="fa fa-file-text-o"></i> Posts
              </a>
            
          </li>
          
          <li class="nav-item">
             
              <a href="//www.elitmus.com/" class="nav-link">
                <i class="el el-elitmuslogo"></i> eLitmus
              </a>
            
          </li>
          

          <!-- feed is the last link -->
          <li class="nav-item">
            <a href="/blog/feed.xml" class="nav-link" title="Atom/RSS feed">
              <i class="fa fa-rss"></i> Feed
            </a>
          </li>
        </ul>



      </div> <!-- /.navbar-collapse -->

  </nav><!--[if lt IE 9]><div class="upgrade"><strong><a href="https://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
</header>
<!-- 

  <div class="search-wrapper">
    <div class="search-form">
      <input type="text" class="search-field" placeholder="Search...">
      <i class="icon-remove-sign icon-2x"></i>
      <ul class="search-results post-list"></ul> -->
<!-- /.search-results -->
<!-- </div> -->
<!-- /.search-form -->
<!-- </div> -->
<!-- ./search-wrapper -->
<!--  -->

  

  <div class="container-fluid">

  <div class="row">


    <div class="col-md-2"></div>
      <div class="col-md-8">
        

        <div id="main" role="main" class="marginal">
          <article class="entry">

            

            <div>
              <header>
                <span class="entry-tags">
                  
                    <a href="/blog/tags/#go" title="Pages tagged go">go</a>
                    &nbsp;&bull;&nbsp;
                  
                    <a href="/blog/tags/#ruby" title="Pages tagged ruby">ruby</a>
                    &nbsp;&bull;&nbsp;
                  
                    <a href="/blog/tags/#buffer" title="Pages tagged buffer">buffer</a>
                    
                  

                  <div class=' social-sharing pull-right'>        
  
    <span class="social-share-facebook">
      <a href="https://www.facebook.com/sharer/sharer.php?u=https://www.elitmus.com/blog/technology/custom-capacity-buffers-in-go/" title="Share on Facebook" itemprop="Facebook"><i class="fa fa-facebook-square fa-lg"></i> Like</a>
    </span>&nbsp;&nbsp;
    <span class="social-share-twitter">
       <a href="https://twitter.com/share?hashtags=technology&text=Custom Capacity Buffers In Go&via=elitmus" title="Share on Twitter" itemprop="Twitter"><i class="fa fa-twitter-square  fa-lg"></i></i> Tweet</a>
    </span>&nbsp;&nbsp;
     
</div>

                </span>
              
                
                  <h1 class="no-padding">Custom Capacity Buffers In Go</h1>
                
              </header>
            </div>
           
            <div>
              <div>
                <span class='badge badge-warning'> <a href="/blog/categories/technology/index.html" > technology </a></span>
              </div>

              
                <div class='pull-left date-show'>
                  <span class="entry-date date published">
                    <time datetime="2015-03-31T00:00:00+05:30">
                      <i class="fa fa-calendar"></i> March 31, 2015
                    </time>
                  </span>&nbsp;

                  

                </div>

                <div class='pull-right date-show'>
                  <span>
                    <a href="/blog/technology/custom-capacity-buffers-in-go/" rel="bookmark" title="Custom Capacity Buffers In Go">
                      <i class="fa fa-link"></i> Permalink
                    </a>
                  </span>
                </div>

              <br>
              <div class="panel panel-default">
                <div class="panel-heading ">
                  <h3 class="panel-title">TL;DR</h3>
                </div>
                <div class="panel-body">
                  <aside>Create Buffers and Files in Golang with Custom Capacity by creating wrapper over Buffer struct in Golang</aside>
                </div>
              </div>
      
            

              <div class="post-content-justify">
                <p>At elitmus we use ruby to create most of our tools and most of our applications  are also written in ruby. Recently I started exploring ways to build our tools especially the backend tools in languages other than ruby which have much lesser memory footprint and better efficiency. One such cases was to create a sandboxed environment for running  untrusted code on our servers. After evaluating multiple languages, I decided to use golang because of it’s excellent library support coupled with the fact the docker(a sandboxed env) was also written in go.</p>

<p>One of the many challenges we faced while creating our sandbox was  redirection of the standard output of untrusted code, as this simple code below will fill up the disk if redirected to file or use all system resources if redirected to a buffer.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c">while(true) printf(“I am the green monster”);</code></pre></figure>

<p>So the problem is,how to limit the size of a file or buffer?, I  started with   buffers  as they are more easy to implement.  I assumed that the <code>Write</code> method of the <code>Buffer</code> struct which writes to the buffer, will panic with <code>ErrTooLarge</code> error if buffer size is above it’s capacity, which i hoped to catch using <code>recover</code> builtin function.</p>

<p>This is the code snippet below.</p>

<figure class="highlight"><pre><code class="language-go" data-lang="go">defer func() {
      if r := recover(); r != nil {
         fmt.Println(&quot;Should catch if anyone panics&quot;)
      }
   }()
  a := bytes.NewBuffer(make([]byte, 0, 2))
  for {
    _,err := a.Write([]byte(&quot;create boom&quot;))
    if err != nil {
      fmt.Println(err.Error())
       return
    }

  }</code></pre></figure>

<p>On running this code, my system was frozen and crashed a little later. This is not what i expected, On further investigation by looking to <a href="https://golang.org/src/bytes/buffer.go?s=4155:4206#L115">source code</a> and reading the <code>bytes</code> package documentation again, i found out that <code>Write</code> method in the <code>bytes</code> package is growing the capacity of the  buffer if the buffer capacity is not enough, which in turn is increasing the amount of memory and resources used by the system.</p>

<p>After some googling and with good help from the go community(thanks to <a href="https://github.com/davecheney">dave cheney</a>), i decided  to create wrapper around the buffer struct and implement my own <code>io.Writer</code> interface by implementing Write method for the wrapper which writes to the buffer.</p>

<p>My custom wrapper’s will take capacity as parameter when initializing and the <code>Write</code> method will do the required action if there is a buffer overflow, instead of increasing the capacity like the <code>Write</code> method from <code>bytes</code> package. This is done by monitoring the size of the buffer before writing to the buffer.</p>

<p>This is code snippet of my custom wrapper.</p>

<figure class="highlight"><pre><code class="language-go" data-lang="go">type MyBuffer struct {
    cap   int
    mybuf *bytes.Buffer
}

func (b *MyBuffer) Write(p []byte) (n int, err error) {
    if len(p)+b.mybuf.Len() &gt; b.cap {
        fmt.Printf(b.mybuf.String())
        panic(&quot;Buffer Overflow&quot;)
    } else {
        b.mybuf.Write(p)
    }
    return len(p), nil
}

func NewBuffer(buf []byte, cap int) *MyBuffer {
    return &amp;MyBuffer{mybuf: bytes.NewBuffer(buf), cap: cap}
}

func main() {

    defer func() {
        if r := recover(); r != nil {
            fmt.Println(&quot;recover in yes&quot;)
        }
    }()

    a := NewBuffer(make([]byte, 0, 100), 200)
    for {
        _, err := a.Write([]byte(&quot;Check for Buffer Overflow&quot;))
        if err != nil {
            fmt.Println(err.Error())
            return
        }
    }
}</code></pre></figure>

<p>On running this code, it worked as expected, hopefully will be deployed in production.
The same goes for files as well.</p>

<p><strong>Note:</strong> useful links, <a href="https://www.docker.com/">on docker</a>,<a href="https://golang.org/pkg/bytes/">on golang bytes package</a></p>


              </div>
              <div class="entry-tags">
                <div class=' social-sharing pull-right'>        
  
    <span class="social-share-facebook">
      <a href="https://www.facebook.com/sharer/sharer.php?u=https://www.elitmus.com/blog/technology/custom-capacity-buffers-in-go/" title="Share on Facebook" itemprop="Facebook"><i class="fa fa-facebook-square fa-lg"></i> Like</a>
    </span>&nbsp;&nbsp;
    <span class="social-share-twitter">
       <a href="https://twitter.com/share?hashtags=technology&text=Custom Capacity Buffers In Go&via=elitmus" title="Share on Twitter" itemprop="Twitter"><i class="fa fa-twitter-square  fa-lg"></i></i> Tweet</a>
    </span>&nbsp;&nbsp;
     
</div>
              </div>
              <div class="clearfix"><br/></div>

                <div class="panel panel-default">

  

  

  
    
      <div class="panel-body">
        <div class="container-fluid">

          <div class="row">
            <div class="col-sm-12 col-md-4">
              <center>
                <img src="/blog/images/surendra.jpg" alt="Surendranath Bobba photo" class="author-photo img-circle img-responsive"/>
                
                <span class="author vcard">
                  <span class="fn">Surendranath Bobba</span>
                </span>

                <div class="nav-icon-size-reduce social-icons">
                  
                    <a href="https://twitter.com/surendrabobba"  title="Surendranath Bobba on Twitter"  target="_blank"><i class="fa fa-twitter "></i></a>
                  
                  
                  
                  

                  
                    <a href="https://linkedin.com/in/bobbasurendra" title="Surendranath Bobba on LinkedIn" target="_blank"><i class="fa fa-linkedin "></i></a>
                  

                  

                  

                  

                  
                    <a href="https://github.com/domitian" title="Surendranath Bobba on Github" target="_blank"><i class="fa fa-github "></i></a>
                  

                     
                </div><!-- /.social-icons -->
              </center>
            </div>

            <div class="col-sm-12 col-md-8">
              
                <span class="author-bio">Surendra is a member of technology team at eLitmus. He is passionate about all things Ancient Rome. Likes to code in javascript and exploring Golang.</span>
              
            </div>

          </div>

        </div>
      </div>

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

</div>
                <div id='discourse-comments'></div>

<script type="text/javascript">
  DiscourseEmbed = { discourseUrl: 'https://adda.elitmus.com/',
                     discourseEmbedUrl: 'https://www.elitmus.com/blog/technology/custom-capacity-buffers-in-go/'
                   };

  (function() {
    var d = document.createElement('script'); 
    d.type = 'text/javascript'; 
    d.async = true;
    d.src = DiscourseEmbed.discourseUrl + 'javascripts/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(d);
  })();
</script>


                
              </div><!-- /.entry-content -->
            </div><!-- /.entry-wrapper -->

          </article>

          <nav class="navbar nav-justified" role="navigation">
            <ul class="nav pager">
              
                <li class="previous showElem mr-auto"><a href="/blog/technology/making-airtel-3g-dongle-work-on-mac-os-10-dot-10-yosemite/" title="Making Airtel 3G dongle work on Mac OS 10.10 Yosemite">&larr;<span class="showPrevNex"> Previous </span> </a></li>
              
              
                <li class="next showElem ml-auto"><a href="/blog/technology/setting-up-elb-plus-nginx-with-https-offloading/" title="Setting up OAuth2 callbacks in Rails with HTTPS offloading on load balancers"> <span class='showPrevNex'> Next </span> &rarr; </a></li>
              
            </ul>
          </nav>
        
        </div><!-- /#main -->

      <!--/col-md-2 -->
      <div class="col-md-2">

      </div>

    </div><!-- /row -->
    </div>
    <div class="footer-color">
      <footer role="contentinfo">
        <center>
            <span class='footer-text'>
    &copy;  2005-<script> document.write(new Date().getFullYear()) </script>, eLitmus.com. | <a href="/terms_of_use/">Terms of Use</a> &middot; <a href="/privacy_policy/">Privacy Policy</a>

  </span>
        </center>
      </footer>
    </div><!-- /.footer-wrapper -->
    

	<script async src="https://www.googletagmanager.com/gtag/js?id=G-CB7H9KN61P"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-CB7H9KN61P');
	</script>



<!-- Load Modernizr -->
<script src="/blog/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- adding jquery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<!-- end of jquery -->

<script src="/blog/assets/js/scripts.min.js"></script>
<script src="/blog/assets/js/lunr.min.js"></script>
<script src="/blog/assets/js/lunr-search.js"></script>
<script src="/blog/assets/js/plugins/headroom.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
<script src="/blog/assets/js/vendor/forkit.js"></script>

<!-- Prism -->
<script src="/blog/assets/js/prism.js"></script>
  

  </body>
</html>
