<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Puma: From Daemonization to Process Control with Systemctl and Monit &#8211; eLitmus Blog</title>
<meta name="description" content="We learn new things everyday, and we document our learnings here...">

<meta name="keywords" content="puma, daemon, systemctl, monit, rails">

<!-- Twitter Cards -->
  <meta name="twitter:card" content="summary">    
<meta name="twitter:title" content="Puma: From Daemonization to Process Control with Systemctl and Monit">
<meta name="twitter:description" content="Puma is a popular Ruby web server that is known for its speed and scalability. It has undergone significant changes in recent versions(starting 5.0.0). One of the most notable alterations is the removal of the daemonization feature. But what does it mean?

">
<meta name="twitter:site" content="@elitmus">
<meta name="twitter:image" content="/blog/images/default_og.png">

    

    

    

    

    

    

    

    

    

    

    

    

    
        
            <meta name="twitter:creator" content="@nick_bhtt">
        
    

    

    

    

    

    

    

    

    




<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:image" content="/blog/images/default_og.png"/>
<meta property="og:image:width" content="1280"/>
<meta property="og:image:height" content="720"/>
<meta property="og:type" content="article">
<meta property="og:title" content="Puma: From Daemonization to Process Control with Systemctl and Monit">
<meta property="og:description" content="Puma is a popular Ruby web server that is known for its speed and scalability. It has undergone significant changes in recent versions(starting 5.0.0). One of the most notable alterations is the removal of the daemonization feature. But what does it mean?

">
<meta property="og:url" content="/blog/technology/puma-from-daemonization-to-process-control-with-systemctl-and-monit/">
<meta property="og:site_name" content="eLitmus Blog">








<link rel="canonical" href="https://www.elitmus.com/blog/technology/puma-from-daemonization-to-process-control-with-systemctl-and-monit/">
<link href="/blog/feed.xml" type="application/atom+xml" rel="alternate" title="eLitmus Blog Feed">


	<link rel="author" href="https://plus.google.com/+eLitmus?rel=author">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Icons -->
<!-- apple touch icons -->
<link rel="apple-touch-icon" sizes="57x57" href="/blog/images/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="114x114" href="/blog/images/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/blog/images/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="144x144" href="/blog/images/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="60x60" href="/blog/images/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="120x120" href="/blog/images/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="76x76" href="/blog/images/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="152x152" href="/blog/images/apple-touch-icon-152x152.png">
<!-- Favicons default 16x16 -->
<link rel="shortcut icon" type="image/vnd.microsoft.icon" href="/blog/favicon.ico">

<!-- Favicons others -->
<link rel="icon" type="image/png" href="/blog/images/favicon-196x196.png" sizes="196x196">
<link rel="icon" type="image/png" href="/blog/images/favicon-160x160.png" sizes="160x160">
<link rel="icon" type="image/png" href="/blog/images/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/blog/images/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/blog/images/favicon-32x32.png" sizes="32x32">

<!-- Icons for Windows 8 Tiles -->
<meta name="msapplication-TileColor" content="#ffffff"/>
<meta name="msapplication-TileImage" content="/blog/images/mstile-144x144.png">

<!-- For all browsers -->


<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:600,300,300italic|The+Girl+Next+Door" rel="stylesheet" type="text/css">
<link href='//fonts.googleapis.com/css?family=Source+Code+Pro:300' rel='stylesheet' type='text/css'>

<meta http-equiv="cleartype" content="on">

<!-- bootstrap 4 -->
<link rel="stylesheet" type="text/css" href="/blog/assets/css/bootstrap.min.css">

<!-- below css file is used for navbar in individual blogposts -->
<link rel="stylesheet" type="text/css" href="/blog/assets/css/main.min.css">

<!-- <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css"> -->

<!-- Optional theme -->
<link rel="stylesheet" type="text/css" href="/blog/assets/css/bootstrap-theme.min.css">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Font Awesome -->
<link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" />
<link rel="stylesheet" type="text/css" href="/blog/assets/css/font-elitmuslogo.css" />

<link rel="stylesheet" href="/blog/assets/css/customize.css">
<link rel="stylesheet" href="/blog/assets/css/forkit.css">

<!-- Prism -->
<link rel="stylesheet" href="/blog/assets/css/prism.css">

</head>

<body id="post">

  <header class="headroom">

  <nav class="navbar navbar-expand-md navbar-dark bg-black fixed-top" role="navigation">

      <a class="navbar-brand" href="/blog/">
        <img src="/blog/images/elitmus-only-logo.svg" class="img-logo">
        <span><div class="blog-label">blog</div></span>
      </a>

      <!-- the toggle button -->
      <button type="button" class="navbar-toggler" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="navbar-toggler-icon"></span>
        <span class="sr-only">Toggle navigation</span><!-- only for screen readers -->
      </button>

      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav mr-auto">

          <!-- first item = dropdown search -->
          <li class="nav-item">
            <div class="dropdown search-box-margin">

            
              <div class="form-inline">
                 

                <input data-toggle="dropdown" placeholder="Search..." id="search-box" class="form-control form-control-sm search-input dropdown-toggle" aria-haspopup="true" aria-expanded="false">


                <div class="dropdown-menu" id="search-dropdown">
                  <a role='presentation' class='dropdown-item search-results'> Type more.... </a>
                </div>

              </div>



            <!-- the below line will pass "search word" to search.html -->

            <!--
            <form class="form-inline" action="/blog/search" method="get">
               


              <label for="search_box">Search</label>
              <input data-toggle="dropdown" type="text" name="query" placeholder="Search..." id="search-box" class="form-control form-control-sm search-input dropdown-toggle" aria-haspopup="true" aria-expanded="false">

              <div class="dropdown-menu" id="search-dropdown">
                  <a role='presentation' class='dropdown-item search-results'> Type more.... </a>
              </div>

              <input type="submit" value="search">

            </form>
            -->

            <!-- end of form -->


            </div>
          </li>
        </ul>

        

        <!-- every link on the right side -->
        <ul class="nav navbar-nav navbar-right nav-icon-size-reduce">
          
          <li class="nav-item">
             
              <a href="/blog/" class="nav-link">
                <i class="fa fa-home"></i> Home
              </a>
            
          </li>
          
          <li class="nav-item">
             
              <a href="/blog/posts/" class="nav-link">
                <i class="fa fa-file-text-o"></i> Posts
              </a>
            
          </li>
          
          <li class="nav-item">
             
              <a href="//www.elitmus.com/" class="nav-link">
                <i class="el el-elitmuslogo"></i> eLitmus
              </a>
            
          </li>
          

          <!-- feed is the last link -->
          <li class="nav-item">
            <a href="/blog/feed.xml" class="nav-link" title="Atom/RSS feed">
              <i class="fa fa-rss"></i> Feed
            </a>
          </li>
        </ul>



      </div> <!-- /.navbar-collapse -->

  </nav><!--[if lt IE 9]><div class="upgrade"><strong><a href="https://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
</header>
<!-- 

  <div class="search-wrapper">
    <div class="search-form">
      <input type="text" class="search-field" placeholder="Search...">
      <i class="icon-remove-sign icon-2x"></i>
      <ul class="search-results post-list"></ul> -->
<!-- /.search-results -->
<!-- </div> -->
<!-- /.search-form -->
<!-- </div> -->
<!-- ./search-wrapper -->
<!--  -->

  

  <div class="container-fluid">

  <div class="row">


    <div class="col-md-2"></div>
      <div class="col-md-8">
        <div id="main" role="main" class="marginal ">
          <article class="entry">

          

            <div>
              <header>
                <span class="entry-tags">
                  
                    <a href="/blog/tags/#puma" title="Pages tagged puma">puma</a>
                    &nbsp;&bull;&nbsp;
                  
                    <a href="/blog/tags/#daemon" title="Pages tagged daemon">daemon</a>
                    &nbsp;&bull;&nbsp;
                  
                    <a href="/blog/tags/#systemctl" title="Pages tagged systemctl">systemctl</a>
                    &nbsp;&bull;&nbsp;
                  
                    <a href="/blog/tags/#monit" title="Pages tagged monit">monit</a>
                    &nbsp;&bull;&nbsp;
                  
                    <a href="/blog/tags/#rails" title="Pages tagged rails">rails</a>
                    
                  

                  <div class=' social-sharing pull-right'>        
     
</div>

                </span>
              
                
                  <h1 class="no-padding">Puma: From Daemonization to Process Control with Systemctl and Monit</h1>
                
              </header>
            </div>
           
            <div>
              <div>
                <span class='badge badge-warning'> <a href="/blog/categories/technology/index.html" > technology </a></span>
              </div>

              

              <div class="post-content-justify">
                <p>Puma is a popular Ruby web server that is known for its speed and scalability. It has undergone significant changes in recent versions(starting 5.0.0). One of the most notable alterations is the removal of the daemonization feature. But what does it mean?</p>

<p>Daemonization, in the context of web servers, is a process that allows a program to run in the background as a system service. In older versions, Puma made it simple for users to daemonize their processes with a straightforward configuration snippet:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">#config/puma.rb
daemonize</code></pre></figure>

<p>However, in recent versions, attempting to use the <code>daemonize</code> code will result in an error, as this functionality has been removed from the  codebase.</p>

<h4 id="why-daemonization-should-not-be-part-of-gem"><strong>Why daemonization should not be part of gem?</strong></h4>
<p>Incorporating daemonization directly within a gem can lead to undesirable consequences: as explained by Mike Perham in a <a href="https://www.mikeperham.com/2014/09/22/dont-daemonize-your-daemons/" target="_blank" style="color: blue;">Blog Post</a>. Here are some key points that should be considered -</p>
<ol>
  <li><strong>Complexity</strong>: Adding daemonization features to a gem can make its code more complex and challenging.</li>
  <li><strong>Maintenance</strong>: The responsibility of maintaining daemonization, automatic restart, and similar core features becomes an additional burden.</li>
  <li><strong>Efficiency</strong>: System processes are better equipped to manage tasks like daemonization. Delegating this function to the system ensures more efficient and reliable execution, rather than embedding it within the gem.</li>
</ol>

<p>As a result of these considerations, Puma decided to remove the daemonization feature from the gem.</p>

<p>This decision led us to make some changes in our setup to ensure the smooth running of our applications.</p>

<h4 id="using-systemd"><strong>Using Systemd</strong></h4>

<p>We had previously implemented daemonization for <a href="https://www.elitmus.com/blog/technology/sidekiq-process-in-production-with-systemd-and-monit" target="_blank" style="color: blue;">Sidekiq</a>, which was a process similar to Puma’s needs. Although there were some minor adjustments required for Puma. Here are steps to achieve daemnization through systemctl:</p>

<ol>
  <li>Remove <code>daemonization</code> from config/puma.rb file</li>
  <li>
    Create a file in <code>/lib/systemd/system/puma.service</code>. Below is sample systemd service configuration example, modify it according to your needs.

    
<figure class="highlight"><pre><code class="language-shell" data-lang="shell">[Unit]
      Description=Puma HTTP Server
      After=network.target

      [Service]
      Type=notify
      User=username

      WorkingDirectory=/dir/path
      ExecStart=/bin/pumactl start -F /path/puma_config --environment env
      ExecStartPost=/bin/sh -c &#39;/bin/echo $MAINPID &gt; /usr/myapp/shared/pids/puma.pid&#39;
      ExecStop=/bin/kill -TSTP $MAINPID

      RestartSec=10
      Restart=on-failure

      [Install]
      WantedBy=multi-user.target</code></pre></figure>

  </li>
  <li>
    Two prominent Puma restart strategies are Phased and Hot restarts. <strong>Phased restarts are slower but ensure that all workers finish their existing requests before restarting the server, while Hot restarts are faster but come with increased latency during the restart.</strong> <br />
    To initiate Puma with a phased restart, you can pass the <code>phased-restart</code> option. This choice offers flexibility to adapt Puma's behavior according to specific needs. More about puma restarts <a href="https://github.com/puma/puma/blob/master/docs/restart.md" target="_blank" style="color: blue;">Here</a>.
  </li>
  <li>
    <strong>Monit configurations</strong><br />

    Monit is a utility for managing and monitoring processes, programs, files, directories and filesystems on a Unix system <a href="https://mmonit.com/monit/" target="_blank" style="color: blue;">Monit Docs</a>. <br />

    Updated <code>monitrc</code> file
    
<figure class="highlight"><pre><code class="language-shell" data-lang="shell">check process puma with pidfile &quot;/usr/myapp/shared/pids/puma.pid&quot;
      start program = &quot;/bin/bash -l -c &#39;sudo systemctl start puma&#39;&quot; with timeout 20 seconds
      stop program = &quot;/bin/bash -l -c &#39;sudo systemctl stop puma&#39;&quot; with timeout 20 seconds
      if totalmem is greater than 800 MB for 3 cycles then restart
      if cpu is greater than 65% for 2 cycles then exec &quot;/etc/monit/slack_notifier.sh&quot; else if succeeded then exec &quot;/etc/monit/slack_notifier.sh&quot;</code></pre></figure>

  </li>
  <li>
    To check if puma is running correctly follow the commands.

    
<figure class="highlight"><pre><code class="language-shell" data-lang="shell">ps aux | grep puma
    sudo monit summary</code></pre></figure>

  </li>
</ol>
<h4 id="exploring-other-alternatives"><strong>Exploring Other Alternatives</strong></h4>

<p>As alternative to this we considered using <a href="https://github.com/kigster/puma-daemon/)  gem. it copied the removed code and maintained a separate gem" target="_blank" style="color: blue;">puma-daemon</a> gem, which essentially replicated the removed code and maintained it in a separate gem. However, after careful consideration, we chose not to adopt this alternative for the following reasons:</p>

<ol>
  <li>Violation of system standards.</li>
  <li>Additional gem and maintainence burden.</li>
</ol>

<h4 id="summary"><strong>Summary</strong></h4>
<p>While the removal of daemonization from Puma may require some adjustments, it aligns with the best practices of modern web server management Managing processes at the system level, using tools like systemd and Monit, is considered a more efficient and maintainable approach. Daemonizing processes within application code is discouraged, as it’s a task that falls under the system level. Ultimately, the shift towards system-level process management ensures the stability and efficiency of web applications.</p>

              </div>
              <div class="entry-tags">
                <div class=' social-sharing pull-right'>        
     
</div>
              </div>
              <div class="clearfix"><br/></div>

                <div class="panel panel-default">

  

  

  

  

  

  

  

  

  

  

  

  

  
    
      <div class="panel-body">
        <div class="container-fluid">

          <div class="row">
            <div class="col-sm-12 col-md-4">
              <center>
                <img src="/blog/images/nikhil.jpg" alt="Nikhil Bhatt photo" class="author-photo img-circle img-responsive"/>
                
                <span class="author vcard">
                  <span class="fn">Nikhil Bhatt</span>
                </span>

                <div class="nav-icon-size-reduce social-icons">
                  
                    <a href="https://twitter.com/nick_bhtt"  title="Nikhil Bhatt on Twitter"  target="_blank"><i class="fa fa-twitter "></i></a>
                  
                  
                  
                  

                  
                    <a href="https://linkedin.com/in/nik-bhatt" title="Nikhil Bhatt on LinkedIn" target="_blank"><i class="fa fa-linkedin "></i></a>
                  

                  

                  

                  

                  
                    <a href="https://github.com/nikhilbhatt" title="Nikhil Bhatt on Github" target="_blank"><i class="fa fa-github "></i></a>
                  

                     
                </div><!-- /.social-icons -->
              </center>
            </div>

            <div class="col-sm-12 col-md-8">
              
                <span class="author-bio">Nikhil Bhatt is a member of Technology at eLitmus. He enjoys creating small, practical software applications and is enthusiastic about competitive coding and chess</span>
              
            </div>

          </div>

        </div>
      </div>

  

  

  

  

  

  

  

  

  

</div>
                <div id='discourse-comments'></div>

<script type="text/javascript">
  DiscourseEmbed = { discourseUrl: 'https://adda.elitmus.com/',
                     discourseEmbedUrl: 'https://www.elitmus.com/blog/technology/puma-from-daemonization-to-process-control-with-systemctl-and-monit/'
                   };

  (function() {
    var d = document.createElement('script'); 
    d.type = 'text/javascript'; 
    d.async = true;
    d.src = DiscourseEmbed.discourseUrl + 'javascripts/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(d);
  })();
</script>


                
              </div><!-- /.entry-content -->
            </div><!-- /.entry-wrapper -->

          </article>

          <nav class="navbar nav-justified" role="navigation">
            <ul class="nav pager">
              
                <li class="previous showElem mr-auto"><a href="/blog/technology/demystifying-rails-7-system-tests-configuring-ci-pipeline/" title="Demystifying Rails 7 System Tests: Configuring CI Pipeline">&larr;<span class="showPrevNex"> Previous </span> </a></li>
              
              
                <li class="next showElem ml-auto"><a href="/blog/technology/building-a-collaborative-code-editor-and-whiteboard-for-tech-interviews/" title="Building a Collaborative code-editor &amp; Whiteboard: For tech interviews."> <span class='showPrevNex'> Next </span> &rarr; </a></li>
              
            </ul>
          </nav>
        
        </div><!-- /#main -->

      <!--/col-md-2 -->
      <div class="col-md-2">

      </div>

    </div><!-- /row -->
    </div>
    <div class="footer-color">
      <footer role="contentinfo">
        <center>
            <span class='footer-text'>
    &copy;  2005-<script> document.write(new Date().getFullYear()) </script>, eLitmus.com. | <a href="/terms_of_use/">Terms of Use</a> &middot; <a href="/privacy_policy/">Privacy Policy</a>

  </span>
        </center>
      </footer>
    </div><!-- /.footer-wrapper -->
    

	<script async src="https://www.googletagmanager.com/gtag/js?id=G-CB7H9KN61P"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-CB7H9KN61P');
	</script>



<!-- Load Modernizr -->
<script src="/blog/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- adding jquery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<!-- end of jquery -->

<script src="/blog/assets/js/scripts.min.js"></script>
<script src="/blog/assets/js/lunr.min.js"></script>
<script src="/blog/assets/js/lunr-search.js"></script>
<script src="/blog/assets/js/plugins/headroom.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
<script src="/blog/assets/js/vendor/forkit.js"></script>

<!-- Prism -->
<script src="/blog/assets/js/prism.js"></script>
  

  </body>
</html>
